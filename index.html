<html>
  <head>
    <title>COVID-19: Public places visited by cases in the community</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=1.0, minimum-scale=1.0, maximum-scale=1.0">
    <meta property="og:image" content="https://ppvbc.github.io/img/ogImage.jpg" />
    <meta property="og:description" content="Public Places Visited by Cases in the Community during Infectious Period in Singapore. Excludes residence, workplaces, healthcare facilities and public transport. There is no need to avoid places where confirmed cases of COVID-19 have been. The National Environment Agency will engage the management of affected premises to provide guidance on cleaning and disinfection." />
  </head>
  <body>
    <div id="title">
      <h4>COVID-19</h4>
      <h5>Public places visited by cases in the community</h5>
    </div>
    <div id="mapdiv"></div>
    <div id="share">
      <a href="https://api.whatsapp.com/send?text=https://ppvbc.github.io" target="_blank"><img id="whatsapp" class="share-button" src="img/whatsapp-button.png"/></a>
      <a href="https://t.me/share/url?url=https://ppvbc.github.io&text=COVID-19: Public places visited by cases in the community" target="_blank"><img id="telegram" class="share-button" src="img/telegram-button.png"/></a>
      <div class="fb-like" data-href="https://ppvbc.github.io" data-width="100" data-layout="box_count" data-action="like" data-size="small" data-share="true"></div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/ramda@0.25.0/dist/ramda.min.js"></script>
    <script src="https://openlayers.org/api/OpenLayers.js"></script>
    <template id="popup">
      <div class="place">
        <div class="content"></div>
      </div>
      <div class="share-place-buttons">
        <i>Tell a friend&nbsp;&nbsp;</i>
        <a class="whatsapp" href="https://api.whatsapp.com/send?text=https://ppvbc.github.io" target="_blank"><img id="whatsapp" class="share-place-button" src="img/whatsapp-button.png"/></a>
        <a class="telegram" href="https://t.me/share/url?url=https://ppvbc.github.io&text=" target="_blank"><img id="telegram" class="share-place-button" src="img/telegram-button.png"/></a>
      </div>
    </template>
    <style>
body {
  font-family: monospace !important;
  margin: 0
}
#title {
  text-align: center;
  position: absolute;
  z-index: 1000;
  width: 100%;
  background: rgba(0,0,0,.1);
}
.olFramedCloudPopupContent {
  font-size: 14px
}
#share {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  bottom: 0;
  z-index: 1000;
  padding: 10px;
}
.share-button {
  width: 50px;
  margin: 5px;
}
.share-place-buttons {
  margin-top: 5px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}
.share-place-button {
  width: 25px;
  margin: 4px;
}
    </style>
    <script>
const map = new OpenLayers.Map("mapdiv")
map.addLayer(new OpenLayers.Layer.OSM('ppvbc', null, { tileOptions: { crossOriginKeyword: null } }))
var zoom = 12
var markers = new OpenLayers.Layer.Markers( "Markers" )
map.addLayer(markers);
map.zoomToExtent()
const formatVenues = R.compose(
  R.map(R.compose(
    R.join(' '),
    R.values,
    R.pick(['date', 'duration', 'venues'])
  )),
  R.prop('places')
)
const formatPlace = R.converge(
  R.concat,
  [ R.compose(R.values, R.pick(['name', 'address'])), formatVenues ]
)
const combinePlaces = R.compose(
  R.reverse,
  R.values,
  R.map((data) => {
    return {
      nodeId: data[0].nodeId,
      relationId: data[0].relationId,
      wayId: data[0].wayId,
      places: data,
      name: data[0].name,
      address: data[0].address
    }
  }),
  R.groupBy((place) => {
    if (place.wayId) return "way" + place.wayId
    if (place.relationId) return "relation" + place.relationId
    if (place.nodeId) return "node" + place.nodeId
  }),
  R.reverse,
  R.map((data) => {
    const regex = /^(.*?) \((.*?)\)(.*)/
    const match = regex.exec(data.name)
    data.name = match[1]
    data.address = match[2]
    data.venues = match[3]
    return data
  })
)

$.getJSON('data.json', (places) => {
  const combinedPlaces = combinePlaces(places)
  $(combinedPlaces).each((idx, place) => {
    var url
    if (place.wayId) {
      url = 'https://api.openstreetmap.org/api/0.6/way/' + place.wayId + '/full.json'
    } else if (place.relationId) {
      url = 'https://api.openstreetmap.org/api/0.6/relation/' + place.relationId + '/full.json'
    } else if (place.nodeId) {
      url = 'https://api.openstreetmap.org/api/0.6/node/' + place.nodeId + '.json'
    }
    $.get(url, (data) => {
      const node = data.elements[0]
      const e = place.wayId || place.relationId
        ? data.elements[data.elements.length - 1]
        : data.elements[0]
        const lonLat = new OpenLayers.LonLat(node.lon, node.lat)
          .transform(
            new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            map.getProjectionObject() // to Spherical Mercator Projection
          )
        const size = new OpenLayers.Size(25, 25)
        const offset = new OpenLayers.Pixel(-(size.w/2), -(size.h/2))
        const icon = new OpenLayers.Icon('img/icon.png', size, offset)
        icon.imageDiv.style.opacity = .5 + (idx / combinedPlaces.length) * .5
        const marker = new OpenLayers.Marker(lonLat, icon);
        markers.addMarker(marker)
        const showPopup = () => {
          $(map.popups).each((idx, popup) => popup.destroy())
          const popupContent = $("#popup").clone().prop('content')
          const contentDiv = $(popupContent).find('div.content')
          const lines = formatPlace(place)
          contentDiv.html(lines.join('<br/>'))
          const whatsappLink = $(popupContent).find('a.whatsapp')
          const whatsappUrl = whatsappLink.attr('href') + encodeURIComponent('\n\n' + lines.join('\n'))
          whatsappLink.attr('href', whatsappUrl)

          const telegramLink = $(popupContent).find('a.telegram')
          const telegramUrl = telegramLink.attr('href') + encodeURIComponent(lines.join('\n'))
          telegramLink.attr('href', telegramUrl)

          const popupHtml = $('<div>').append(popupContent).html()
          const popup = new OpenLayers.Popup.FramedCloud('place_' + idx,
                                                         lonLat,
                                                         new OpenLayers.Size(600, 600),
                                                         popupHtml,
                                                         null,
                                                         false)
          $(popup.contentDiv).click(() => popup.destroy())
          map.addPopup(popup)
        }
        marker.events.register('click', marker, showPopup)
        marker.events.register('touchstart', marker, showPopup)
    })
  })
})
const centerLonLat = new OpenLayers.LonLat(103.8198, 1.3521)
  .transform(
    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
    map.getProjectionObject() // to Spherical Mercator Projection
  )
map.setCenter(centerLonLat, zoom)

    </script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DX3978HE37"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DX3978HE37');
</script>
  </body>
</html>
