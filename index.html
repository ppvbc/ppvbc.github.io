<html>
  <head>
    <title>COVID-19: Public places visited by cases in the community</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=1.0, minimum-scale=1.0, maximum-scale=1.0">
    <meta property="og:image" content="https://ppvbc.github.io/img/ogImage.jpg" />
    <meta property="og:description" content="Public Places Visited by Cases in the Community during Infectious Period in Singapore. Excludes residence, workplaces, healthcare facilities and public transport. There is no need to avoid places where confirmed cases of COVID-19 have been. The National Environment Agency will engage the management of affected premises to provide guidance on cleaning and disinfection." />
    <script data-ad-client="ca-pub-6306676453790058" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.js"></script>
  </head>
  <body>
    <div id="title">
      <h4>COVID-19</h4>
      <h5>Public places visited by cases in the community</h5>
    </div>
    <div id="mapdiv"></div>
    <div id="footer">
      <div id="ad-0" class="ad">
        <span>Let's TraceTogether.</span>
        <a id="alink" href="https://qoo.tn/BLwceX/Q167759988" target="_blank">Buy a Token Cover</a>
      </div>
      <div id="ad-1" class="ad">
        <span>Stay Safe. Mask Up.</span>
        <a id="alink" href="https://qoo.tn/Bt1deX/Q167759988" target="_blank">Try KF94 Mask</a>
      </div>
      <div id="ad-2" class="ad">
        <span>Stay Safe. Work from home.</span>
        <a id="alink" href="https://c.lazada.sg/t/c.bIBHTu?url=https%3A%2F%2Fwww.lazada.sg%2Fproducts%2Flogitech-h340-usb-headset-i107618077-s110578173.html&" target="_blank">Buy a headset <ion-icon name="headset"></ion-icon></a>
      </div>
    </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/ramda@0.25.0/dist/ramda.min.js"></script>
    <script src="https://openlayers.org/api/OpenLayers.js"></script>
    <template id="popup">
      <div class="place">
        <div class="content"></div>
      </div>
      <div class="share-place-buttons">
        <i>Tell a friend&nbsp;&nbsp;</i>
        <a class="whatsapp" href="https://api.whatsapp.com/send?text=https://ppvbc.github.io" target="_blank"><img id="whatsapp" class="share-place-button" src="img/whatsapp-button.png"/></a>
        <a class="telegram" href="https://t.me/share/url?url=https://ppvbc.github.io&text=" target="_blank"><img id="telegram" class="share-place-button" src="img/telegram-button.png"/></a>
      </div>
    </template>
    <style>
html, body {
  font-family: monospace !important;
  width: 100%;
  margin: 0px;
  padding: 0px;
  overflow-x: hidden;
}
#title {
  text-align: center;
  position: absolute;
  z-index: 1000;
  width: 100%;
  background: rgba(0,0,0,.1);
}
.olFramedCloudPopupContent {
  font-size: 14px
}
.olFramedCloudPopupContent .new {
  font-size: 8px;
  position: absolute;
  right: 4px;
  top: 0px;
  background: #FFA300;
  padding: 3px 5px;
  color: white;
  border-radius: 2px;
}
.ad {
  display: none;
}
#alink {
  padding: 3px 8px;
  background: #FFA300;
  border-radius: 3px;
  text-decoration: none;
  color: white;
  box-shadow: 1px 1px grey;
}
#alink ion-icon {
  font-size: 10px;
}
#footer {
  position: absolute;
  align-items: center;
  justify-content: center;
  display: flex;
  width: 100%;
  bottom: 0;
  z-index: 1000;
  margin: 0;
  padding: 10px 0;
  background: rgba(0,0,0,.1);
}
.share-place-buttons {
  margin-top: 5px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}
.share-place-button {
  width: 25px;
  margin: 4px;
}
    </style>
    <script>
const map = new OpenLayers.Map("mapdiv")
const osm = new OpenLayers.Layer.OSM('ppvbc', null, { tileOptions: { crossOriginKeyword: null } })
function closePopups(e) {
  $(map.popups).each((idx, popup) => popup.destroy())
}
map.addLayer(osm)
var zoom = 12
var markers = new OpenLayers.Layer.Markers( "Markers" )
map.addLayer(markers);
map.zoomToExtent()
const formatVenues = R.compose(
  R.map(R.compose(
    R.join(' '),
    R.values,
    R.pick(['date', 'duration', 'venues'])
  )),
  R.prop('places')
)
const formatPlace = R.converge(
  R.concat,
  [ R.compose(R.values, R.pick(['name', 'address'])), formatVenues ]
)
const getId = R.prop('id')
const combinePlaces = R.compose(
  R.reverse,
  R.values,
  R.map((data) => {
    return {
      id: data[0].id,
      places: data,
      lon: data[0].lon,
      lat: data[0].lat,
      name: data[0].name,
      address: data[0].address
    }
  }),
  R.groupBy(getId),
  R.reverse,
  R.map((data) => {
    const regex = /^(.*?) \((.*?)\)(.*)/
    const match = regex.exec(data.name)
    data.name = match[1]
    data.address = match[2]
    data.venues = match[3]
    return data
  })
)
const compareId = (a, b) => getId(a) == getId(b)
const adId = Math.floor(Math.random() * $('.ad').length)
$($('.ad')[adId]).show()

$.getJSON('data-prev-fetched.json', (prevPlaces) => {
  const combinedPrevPlaces = combinePlaces(prevPlaces)
  $.getJSON('data-fetched.json', (places) => {
    const combinedPlaces = combinePlaces(places)
    const newPlaces = R.differenceWith(compareId, combinedPlaces, combinedPrevPlaces)
    const newPlacesId = R.map(getId, newPlaces)
    $(combinedPlaces).each((idx, place) => {
      const placeId = place.id
      const isNew = R.contains(placeId, newPlacesId)
      const lonLat = new OpenLayers.LonLat(place.lon, place.lat)
        .transform(
          new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
          map.getProjectionObject() // to Spherical Mercator Projection
        )
      const size = new OpenLayers.Size(25, 25)
      const offset = new OpenLayers.Pixel(-(size.w/2), -(size.h/2))
      const icon = new OpenLayers.Icon((isNew ? 'img/icon-new.png' : 'img/icon.png'), size, offset)
      icon.imageDiv.style.opacity = .5 + (idx / combinedPlaces.length) * .5
      const marker = new OpenLayers.Marker(lonLat, icon);
      markers.addMarker(marker)
      const showPopup = () => {
        closePopups()
        const popupContent = $("#popup").clone().prop('content')
        const contentDiv = $(popupContent).find('div.content')
        const lines = formatPlace(place)
        contentDiv.html((isNew ? '<span class="new">New</span>': '') + lines.join('<br/>'))

        const whatsappLink = $(popupContent).find('a.whatsapp')
        const whatsappUrl = whatsappLink.attr('href') + encodeURIComponent('\n\n' + lines.join('\n'))
        whatsappLink.attr('href', whatsappUrl)

        const telegramLink = $(popupContent).find('a.telegram')
        const telegramUrl = telegramLink.attr('href') + encodeURIComponent(lines.join('\n'))
        telegramLink.attr('href', telegramUrl)

        const popupHtml = $('<div>').append(popupContent).html()
        const popup = new OpenLayers.Popup.FramedCloud(placeId,
                                                       lonLat,
                                                       new OpenLayers.Size(600, 600),
                                                       popupHtml,
                                                       null,
                                                       false)
        $(popup.contentDiv).click(() => popup.destroy())
        map.addPopup(popup)
      }
      marker.events.register('click', marker, showPopup)
      marker.events.register('touchstart', marker, showPopup)
    })
  })
})
const centerLonLat = new OpenLayers.LonLat(103.8198, 1.3521)
  .transform(
    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
    map.getProjectionObject() // to Spherical Mercator Projection
  )
map.setCenter(centerLonLat, zoom)
    </script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DX3978HE37"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DX3978HE37');
</script>
  </body>
</html>
