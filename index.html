<html>
  <head>
    <title>COVID-19: Public places visited by cases in the community</title>
  </head>
  <body>
    <div id="title">
      <h1>COVID-19</h1>
      <h2>Public places visited by cases in the community</h2>
    </div>
    <div id="mapdiv"></div>
    <div id="share">
      <a href="https://api.whatsapp.com/send?text=https://ppvbc.github.io" target="_blank"><img id="whatsapp" src="img/whatsapp-button.png"/></a>
      <a href="https://t.me/share/url?url=https://ppvbc.github.io&text=COVID-19: Public places visited by cases in the community" target="_blank"><img id="whatsapp" src="img/telegram-button.png"/></a>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/ramda@0.25.0/dist/ramda.min.js"></script>
    <script src="https://openlayers.org/api/OpenLayers.js"></script>
    <style>
body {
  font-family: monospace !important;
  margin: 0
}
#title {
  text-align: center;
  position: absolute;
  z-index: 1000;
  width: 100%;
}
.olFramedCloudPopupContent {
  font-size: 12px
}
#share {
  position: absolute;
  text-align: center;
  bottom: 0;
  z-index: 1000;
  padding: 20px;
}
    </style>
    <script>
const map = new OpenLayers.Map("mapdiv")
map.addLayer(new OpenLayers.Layer.OSM('ppvbc', null, { tileOptions: { crossOriginKeyword: null } }))
var zoom = 12
var markers = new OpenLayers.Layer.Markers( "Markers" )
map.addLayer(markers);
map.zoomToExtent()
const formatVenues = R.compose(
  R.map(R.compose(
    R.join('&nbsp;'),
    R.values,
    R.pick(['date', 'duration', 'venues'])
  )),
  R.prop('places')
)
const formatPlace = R.converge(
  R.concat,
  [ R.compose(R.values, R.pick(['name', 'address'])), formatVenues ]
)

$.getJSON('data.json', (places) => {

  const combinePlaces = R.compose(
    R.values,
    R.map((data) => {
      return {
        nodeId: data[0].nodeId,
        relationId: data[0].relationId,
        wayId: data[0].wayId,
        places: data,
        name: data[0].name,
        address: data[0].address
      }
    }),
    R.groupBy((place) => {
      if (place.wayId) return "way" + place.wayId
      if (place.relationId) return "relation" + place.relationId
      if (place.nodeId) return "node" + place.nodeId
    }),
    R.map((data) => {
      const regex = /^(.*?) \((.*?)\)(.*)/
      const match = regex.exec(data.name)
      data.name = match[1]
      data.address = match[2]
      data.venues = match[3]
      return data
    })
  )
  const combinedPlaces = combinePlaces(places)
  $(combinedPlaces).each((idx, place) => {
    var url
    if (place.wayId) {
      url = 'https://api.openstreetmap.org/api/0.6/way/' + place.wayId + '/full.json'
    } else if (place.relationId) {
      url = 'https://api.openstreetmap.org/api/0.6/relation/' + place.relationId + '/full.json'
    } else if (place.nodeId) {
      url = 'https://api.openstreetmap.org/api/0.6/node/' + place.nodeId + '.json'
    }
    $.get(url, (data) => {
      const node = data.elements[0]
      const e = place.wayId || place.relationId
        ? data.elements[data.elements.length - 1]
        : data.elements[0]
        const lonLat = new OpenLayers.LonLat(node.lon, node.lat)
          .transform(
            new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            map.getProjectionObject() // to Spherical Mercator Projection
          )
        const size = new OpenLayers.Size(25, 25)
        const offset = new OpenLayers.Pixel(-(size.w/2), -(size.h/2))
        const icon = new OpenLayers.Icon('img/icon.png', size, offset)
        const marker = new OpenLayers.Marker(lonLat, icon);
        markers.addMarker(marker)
        const showPopup = () => {
          const popup = new OpenLayers.Popup.FramedCloud('place_' + idx,
                                                         lonLat,
                                                         new OpenLayers.Size(600, 600),
                                                         formatPlace(place).join('<br/>'),
                                                         null,
                                                         false)
          $(popup.contentDiv).click(() => popup.destroy())
          map.addPopup(popup)
        }
        marker.events.register('click', marker, showPopup)
        marker.events.register('touchstart', marker, showPopup)
    })
  })
})
const centerLonLat = new OpenLayers.LonLat(103.8198, 1.3521)
  .transform(
    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
    map.getProjectionObject() // to Spherical Mercator Projection
  )
map.setCenter(centerLonLat, zoom)

    </script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DX3978HE37"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DX3978HE37');
</script>
  </body>
</html>
