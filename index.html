<html>
  <head>
    <title>COVID-19: Public places visited by cases in the community</title>
  </head>
  <body>
    <div id="title">
      <h1>COVID-19</h1>
      <h2>Public places visited by cases in the community</h2>
    </div>
    <div id="mapdiv"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://openlayers.org/api/OpenLayers.js"></script>
    <style>
body {
  font-family: monospace !important;
  margin: 0
}
#title {
  text-align: center;
  position: absolute;
  z-index: 1000;
  width: 100%;
}
.olFramedCloudPopupContent {
  font-size: 32px
}
    </style>
    <script>
const map = new OpenLayers.Map("mapdiv")
map.addLayer(new OpenLayers.Layer.OSM('ppvbc', null, { tileOptions: { crossOriginKeyword: null } }))
var zoom = 12
var markers = new OpenLayers.Layer.Markers( "Markers" )
map.addLayer(markers);
map.zoomToExtent()
$.getJSON('data.json', (places) => {
  $(places).each((idx, place) => {
    var url
    if (place.wayId) {
      url = 'https://api.openstreetmap.org/api/0.6/way/' + place.wayId + '/full.json'
    } else if (place.relationId) {
      url = 'https://api.openstreetmap.org/api/0.6/relation/' + place.relationId + '/full.json'
    } else if (place.nodeId) {
      url = 'https://api.openstreetmap.org/api/0.6/node/' + place.nodeId + '.json'
    }
    $.get(url, (data) => {
      const node = data.elements[0]
      const e = place.wayId || place.relationId
        ? data.elements[data.elements.length - 1]
        : data.elements[0]
        const lonLat = new OpenLayers.LonLat(node.lon, node.lat)
          .transform(
            new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            map.getProjectionObject() // to Spherical Mercator Projection
          )
        const marker = new OpenLayers.Marker(lonLat);
        markers.addMarker(marker)
        const name = (place.name || e.tags && e.tags.name)
        const showPopup = () => {
          const popup = new OpenLayers.Popup.FramedCloud('place_' + idx,
                                                         lonLat,
                                                         new OpenLayers.Size(600, 600),
                                                         name.replace(/\)/, '<br/>').replace(/\(/, '<br/>').replace(/•/g, '<br/>•') + '<br/>' + place.date + '<br/>' + place.duration,
                                                         null,
                                                         false)
          $(popup.groupDiv).click(() => popup.destroy())
          map.addPopup(popup)
        }
        marker.events.register('click', marker, showPopup)
        marker.events.register('touchstart', marker, showPopup)
    })
  })
})
const centerLonLat = new OpenLayers.LonLat(103.8198, 1.3521)
  .transform(
    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
    map.getProjectionObject() // to Spherical Mercator Projection
  )
map.setCenter(centerLonLat, zoom)

    </script>
  </body>
</html>
