<html>
  <head>
    <title>COVID-19: Public places visited by cases in the community</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=1.0, minimum-scale=1.0, maximum-scale=1.0">
    <meta property="og:image" content="https://ppvbc.github.io/img/ogImage.jpg" />
    <meta property="og:description" content="Public Places Visited by Cases in the Community during Infectious Period in Singapore. Excludes residence, workplaces, healthcare facilities and public transport. There is no need to avoid places where confirmed cases of COVID-19 have been. The National Environment Agency will engage the management of affected premises to provide guidance on cleaning and disinfection." />
    <script data-ad-client="ca-pub-6306676453790058" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  </head>
  <body>
    <div id="title">
      <h4>COVID-19</h4>
      <h5>Public places visited by cases in the community</h5>
    </div>
    <div id="mapdiv"></div>
    <div id="footer">
      <div id="lastUpdated"></div>
      <div id="ads">
      <!--
        <div id="ad-1" class="ad">
          <span>Stay Safe. Mask Up.</span>
          <a id="alink-1" class="alink" href="https://shopee.sg/universal-link/-Korea-%F0%9F%87%B0%F0%9F%87%B74ply-3D-Mask%E3%85%A3KF94-Korean-Face-mask-approved-KFDA%E3%85%A3Black-White%E3%85%A3Slim-Large-size-l-Disposable-Antibacterial-Protective-i.350565725.4670845842?utm_source=14302920000&utm_medium=affiliates&utm_campaign=CHPeck_K94Mask&utm_content=----&af_siteid=an_14302920000&pid=affiliates&af_click_lookback=7d&af_viewthrough_lookback=1d&is_retargeting=true&af_reengagement_window=7d&af_sub_siteid=----&c=----" target="_blank">Try KF94 Mask</a>
        </div>
        <div id="ad-2" class="ad">
          <span>Stay Home. Stay Safe.</span>
          <a id="alink-2" class="alink" href="https://shopee.sg/m/stay-safe-stay-home?utm_source=14302920000&utm_medium=affiliates&utm_campaign=CHPeck_SHSSCampaign&utm_content=----&af_siteid=an_14302920000&pid=affiliates&af_click_lookback=7d&af_viewthrough_lookback=1d&is_retargeting=true&af_reengagement_window=7d&af_sub_siteid=----&c=----" target="_blank">Get your essentials</a>
        </div>
        <div id="ad-3" class="ad">
          <span>Work from home.</span>
          <a id="alink-3" class="alink" href="https://shopee.sg/universal-link/collections/764371?utm_source=14302920000&utm_medium=affiliates&utm_campaign=CHPeck_LogitechC920&utm_content=----&af_siteid=an_14302920000&pid=affiliates&af_click_lookback=7d&af_viewthrough_lookback=1d&is_retargeting=true&af_reengagement_window=7d&af_sub_siteid=----&c=----" target="_blank">Upgrade your gear</a> </div>
      -->
        <div id="ad-special" class="ad">
          <span>Work from home.</span>
          <a id="alink-special" class="alink" href="https://shopee.sg/universal-link/Logitech-H340-USB-Headset-with-Noise-Cancelling-Mic-i.120981896.3242258901?utm_source=14302920000&utm_medium=affiliates&utm_campaign=CHPeck_LogitechH340&utm_content=----%20&af_siteid=an_14302920000&pid=affiliates&af_click_lookback=7d&af_viewthrough_%20lookback=1d&is_retargeting=true&af_reengagement_window=7d&af_sub_siteid=----&c=----" target="_blank">Get a headset</a>
        </div>
      </div>
    </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/ramda@0.25.0/dist/ramda.min.js"></script>
    <script src="https://openlayers.org/api/OpenLayers.js"></script>
    <template id="popup">
      <div class="place">
        <div class="content"></div>
      </div>
      <div class="share-place-buttons">
        <i>Tell a friend&nbsp;&nbsp;</i>
        <a class="whatsapp" href="https://api.whatsapp.com/send?text=https://ppvbc.github.io" target="_blank"><img id="whatsapp" class="share-place-button" src="img/whatsapp-button.png"/></a>
        <a class="telegram" href="https://t.me/share/url?url=https://ppvbc.github.io&text=" target="_blank"><img id="telegram" class="share-place-button" src="img/telegram-button.png"/></a>
      </div>
    </template>
    <style>
html, body {
  font-family: monospace !important;
  width: 100%;
  margin: 0px;
  padding: 0px;
  overflow-x: hidden;
}
#title {
  text-align: center;
  position: absolute;
  z-index: 1000;
  width: 100%;
  background: rgba(0,0,0,.1);
}
.olFramedCloudPopupContent {
  font-size: 14px
}
.olFramedCloudPopupContent .new {
  font-size: 8px;
  position: absolute;
  right: 4px;
  top: 0px;
  background: #FFA300;
  padding: 3px 5px;
  color: white;
  border-radius: 2px;
}
.olFramedCloudPopupContent ul {
  font-size: 12px;
  list-style: none;
  margin: 0;
  padding: 10px 0 0 0;
}
.ad {
  display: none;
}
.alink {
  width: 100%;
  padding: 3px 8px;
  background: #FFA300;
  border-radius: 3px;
  text-decoration: none;
  color: white;
  box-shadow: 1px 1px grey;
}
#lastUpdated {
  font-size: 10px;
  position: absolute;
  width: 100%;
  top: -26px;
  left: 5px;
}
#ads {
  display: flex;
  align-items: center;
  justify-content: center;
}
#footer {
  z-index: 1000;
  background: rgba(0,0,0,.1);
  display: flex;
  flex-direction: column;
  position: absolute;
  bottom: 0;
  margin: 0;
  padding: 10px 0;
  width: 100%;
}
.share-place-buttons {
  margin-top: 5px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}
.share-place-button {
  width: 25px;
  margin: 4px;
}
    </style>
    <script>
const map = new OpenLayers.Map("mapdiv")
const osm = new OpenLayers.Layer.OSM('ppvbc', null, { tileOptions: { crossOriginKeyword: null } })
const showAd = () => {
  const adIdx = Math.floor(Math.random() * $('.ad').length)
  $('.ad').hide()
  $($('.ad')[adIdx]).show()
}
showAd()
function closePopups(e) {
  $(map.popups).each((idx, popup) => popup.destroy())
}
map.addLayer(osm)
var zoom = 12
var markers = new OpenLayers.Layer.Markers( "Markers" )
map.addLayer(markers);
map.zoomToExtent()
const formatVenues = R.compose(
  R.map(R.compose(
    R.join(' '),
    R.values,
    R.pick(['date', 'duration', 'venues'])
  )),
  R.prop('visits')
)
const formatPlace = R.converge(
  R.concat,
  [ R.compose(R.values, R.pick(['name', 'address'])), formatVenues ]
)
function formatPlaceHtml (place) {
  var html = '<strong>' + place.name + '</strong><br/>'
  html += '<span>' + place.address + '</span>'
  html += '<ul>'
  $(place.visits).each((idx, visit) => {
    const venues = visit.venues && visit.venues.length
      ? '\u2022 ' + visit.venues.join(', ')
      : ''
    html += '<li>' + [visit.date, visit.duration, venues].join('&nbsp;') + '</li>'
  })
  html += '</ul>'
  return html
}
$.getJSON('places-fetched.json', {_: new Date().getTime()}, (data) => {
  const places = data.places
  const timestamp = data.timestamp
  $('#lastUpdated').html('Last updated: ' + new Date(timestamp).toLocaleDateString())
  $(places).each((idx, place) => {
    const placeId = place.id
    const lonLat = new OpenLayers.LonLat(place.lon, place.lat)
      .transform(
        new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
        map.getProjectionObject() // to Spherical Mercator Projection
      )
    const size = new OpenLayers.Size(25, 25)
    const offset = new OpenLayers.Pixel(-(size.w/2), -(size.h/2))
    const icon = new OpenLayers.Icon((place.isNew ? 'img/icon-new.png' : 'img/icon.png'), size, offset)
    icon.imageDiv.style.opacity = .5 + (idx / places.length) * .5
    const marker = new OpenLayers.Marker(lonLat, icon);
    markers.addMarker(marker)
    const showPopup = () => {
      closePopups()
      const popupContent = $("#popup").clone().prop('content')
      const contentDiv = $(popupContent).find('div.content')
      const lines = formatPlace(place)
      const placeHtml = formatPlaceHtml(place)
      contentDiv.html((place.isNew ? '<span class="new">New</span>': '') + placeHtml)

      const whatsappLink = $(popupContent).find('a.whatsapp')
      const whatsappUrl = whatsappLink.attr('href') + encodeURIComponent('\n\n' + lines.join('\n'))
      whatsappLink.attr('href', whatsappUrl)

      const telegramLink = $(popupContent).find('a.telegram')
      const telegramUrl = telegramLink.attr('href') + encodeURIComponent(lines.join('\n'))
      telegramLink.attr('href', telegramUrl)

      const popupHtml = $('<div>').append(popupContent).html()
      const popup = new OpenLayers.Popup.FramedCloud(placeId,
                                                     lonLat,
                                                     new OpenLayers.Size(600, 600),
                                                     popupHtml,
                                                     null,
                                                     false)
      $(popup.contentDiv).click(() => {
        closePopups()
        showAd()
      })
      map.addPopup(popup)
    }
    marker.events.register('click', marker, showPopup)
    marker.events.register('touchstart', marker, showPopup)
  })
})
const centerLonLat = new OpenLayers.LonLat(103.8198, 1.3521)
  .transform(
    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
    map.getProjectionObject() // to Spherical Mercator Projection
  )
map.setCenter(centerLonLat, zoom)
    </script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DX3978HE37"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DX3978HE37');
</script>
  </body>
</html>
